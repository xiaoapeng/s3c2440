TOOLS := arm-none-linux-gnueabi-
CC := $(TOOLS)gcc
LD := $(TOOLS)ld
OBJCOPY := $(TOOLS)objcopy
OBJDUMP := $(TOOLS)objdump
#宏开关选项
CONFIG_DEBUG =n




#编译选项
CFLAGS :=  -nostdlib  -O0 -I ./drv -I ./lib -I ./debug




#目标文件名
TARGET	:= text


#CONFIG_DEBUG
LDFLAGS =
NCOMPREQ :=\?
ifeq ($(CONFIG_DEBUG),y)
LDFLAGS += -L $(shell dirname `$(CC) -print-libgcc-file-name`) -lgcc
CFLAGS	+=-DCONFIG_DEBUG
else
#不需要编译的文件夹
NCOMPREQ +=|debug/
endif


SOURCE_C 	:=$(shell find *|grep "\.[c]$$"|grep -v -P "($(NCOMPREQ))")
SOURCE_ASM 	:=$(shell find *|grep "\.[Ss]$$")
OBJS_C		:=$(shell echo $(SOURCE_C)|sed "s/\.[c]\b/.o/g")
OBJS_ASM	:=$(shell echo $(SOURCE_ASM)|sed "s/\.[sS]\b/.o/g")
OBJS += $(OBJS_ASM) $(OBJS_C)

$(TARGET).bin:$(OBJS)
	$(LD)  -T link.lds $^ -o $(TARGET).elf $(LDFLAGS)
	$(OBJCOPY) -O binary -S $(TARGET).elf $(TARGET).bin
	$(OBJDUMP) -D $(TARGET).elf > $(TARGET).dis
	@chmod 777 *
	 

$(OBJS_C):%.o : %.c 

$(OBJS_ASM):%.o : %.S 




flash:../tools/mk4412 $(TARGET).bin
	../tools/mk4412 $(TARGET).bin
	@if [ -b /dev/sdb ]; then \
	sudo mkfs.vfat -F 32 -I /dev/sdb; \
	sudo dd if=/dev/zero of=/dev/sdb bs=512 seek=1 iflag=dsync oflag=dsync count=2048; \
	sudo dd if=./$(TARGET).bin of=/dev/sdb bs=512 seek=1 iflag=dsync oflag=dsync; \
	fi
	
../tools/mk4412 : ../tools/mk4412.c
	gcc  $^ -static -o ../tools/mk4412

.PHONY :clean

clean:
	rm -rf $(OBJS) *.elf *.dis *.bin
	
	




